@model HaveASeat.Models.Salone

@{
    Layout = "_DashboardLayout";
    var giorni = new[] { "Lunedì", "Martedì", "Mercoledì", "Giovedì", "Venerdì", "Sabato", "Domenica" };
    // Mapping indice display → DayOfWeek: Lun=1, Mar=2, ..., Dom=0
    var dayOrder = new int[] { 1, 2, 3, 4, 5, 6, 0 };
}

<!-- Header -->
<div class="flex flex-col lg:flex-row lg:items-center justify-between mb-8 space-y-4 lg:space-y-0">
    <div class="flex items-center space-x-4">
        <a href="/Partner/ManageSede/@Model.SaloneId" class="inline-flex items-center justify-center w-10 h-10 bg-gray-100 dark:bg-gray-700 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
            <i class="fas fa-arrow-left text-gray-600 dark:text-gray-300"></i>
        </a>
        <div class="flex items-center space-x-4">
            <div class="w-16 h-16 bg-gradient-to-br from-green-500 to-emerald-500 rounded-full flex items-center justify-center shadow-lg">
                <i class="fas fa-clock text-white text-xl"></i>
            </div>
            <div>
                <h1 class="text-3xl font-bold text-gray-900 dark:text-gray-100">Orari di @Model.Nome</h1>
                <p class="text-gray-600 dark:text-gray-400 mt-1">Configura gli orari di apertura della sede</p>
            </div>
        </div>
    </div>

    <div class="flex items-center space-x-3">
        <button onclick="resetSchedule()" class="inline-flex items-center px-4 py-2 border border-gray-300 dark:border-gray-600 text-sm font-medium rounded-lg text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
            <i class="fas fa-undo mr-2"></i>
            Reset
        </button>
    </div>
</div>

@if (TempData["SuccessMessage"] != null)
{
    <div class="bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg p-4 mb-6">
        <div class="flex items-center">
            <i class="fas fa-check-circle text-green-600 dark:text-green-400 mr-3"></i>
            <span class="text-green-700 dark:text-green-300">@TempData["SuccessMessage"]</span>
        </div>
    </div>
}

<!-- Schedule Form -->
<div class="max-w-6xl mx-auto">
    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl border border-gray-200 dark:border-gray-700 overflow-hidden">
        <!-- Header Card -->
        <div class="bg-gradient-to-r from-green-600 to-emerald-600 px-8 py-6">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="text-2xl font-bold text-white">Pianificazione Settimanale</h2>
                    <p class="text-green-100 mt-1">Configura gli orari di apertura e chiusura per ogni giorno della settimana</p>
                </div>
                <div class="text-right">
                    <div class="text-white text-sm">
                        <i class="fas fa-calendar-week mr-2"></i>
                        <span id="work-days-display">@Model.Orari.Count(o => !o.IsDayOff) giorni di apertura</span>
                    </div>
                </div>
            </div>
        </div>

        <form method="post" id="scheduleForm" class="p-8">
            @Html.AntiForgeryToken()
            <div class="space-y-6">
                @for (int i = 0; i < 7; i++)
                {
                    var dow = dayOrder[i]; // valore DayOfWeek reale (1=Mon, 2=Tue, ..., 0=Sun)
                    var orario = Model.Orari.FirstOrDefault(o => (int)o.Giorno == dow);
                    var isWorkDay = orario != null && !orario.IsDayOff;

                    <div class="schedule-day bg-gray-50 dark:bg-gray-700/50 rounded-xl p-6 border border-gray-200 dark:border-gray-600" data-day="@i">

                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center space-x-4">
                                <div class="w-12 h-12 bg-gradient-to-br from-green-500 to-emerald-500 rounded-lg flex items-center justify-center">
                                    <span class="text-white font-bold text-sm">@giorni[i].Substring(0, 3).ToUpper()</span>
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100">@giorni[i]</h3>
                                    <p class="text-sm text-gray-500 dark:text-gray-400" id="status-@i">
                                        @if (isWorkDay && orario != null)
                                        {
                                            var aperturaStr = orario.Apertura.ToString(@"hh\:mm");
                                            var chiusuraStr = orario.Chiusura.ToString(@"hh\:mm");

                                            <span>@aperturaStr - @chiusuraStr</span>
                                        }
                                        else
                                        {
                                            <span>Chiuso</span>
                                        }
                                    </p>
                                </div>
                            </div>

                            <!-- Toggle Switch -->
                            <div class="form-control">
                                <label class="label cursor-pointer">
                                    <span class="label-text mr-3 font-medium text-gray-700 dark:text-gray-300">Aperto</span>
                                    <input type="checkbox"
                                           class="toggle toggle-success work-day-toggle"
                                           name="WorkDays"
                                           value="@dow"
                                           data-day="@i"
                                    @(isWorkDay ? "checked" : "")
                                           onchange="toggleWorkDay(@i)" />
                                </label>
                            </div>
                        </div>

                        <!-- Time Inputs -->
                        <div class="time-inputs grid grid-cols-1 md:grid-cols-2 gap-6 @(!isWorkDay ? "hidden" : "")" id="time-inputs-@i">
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text font-medium text-gray-700 dark:text-gray-300">
                                        <i class="fas fa-clock mr-2 text-green-600"></i>
                                        Ora di apertura
                                    </span>
                                </label>
                                <input type="time"
                                       name="Orari[apertura_@dow]"
                                       value="@(isWorkDay && orario != null ? orario.Apertura.ToString(@"hh\:mm") : "09:00")"
                                       class="input input-bordered focus:border-green-500 focus:ring-2 focus:ring-green-200 dark:bg-gray-700 dark:text-gray-100"
                                       onchange="updateStatus(@i)" />
                            </div>

                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text font-medium text-gray-700 dark:text-gray-300">
                                        <i class="fas fa-door-open mr-2 text-green-600"></i>
                                        Ora di chiusura
                                    </span>
                                </label>
                                <input type="time"
                                       name="Orari[chiusura_@dow]"
                                       value="@(isWorkDay && orario != null ? orario.Chiusura.ToString(@"hh\:mm") : "18:00")"
                                       class="input input-bordered focus:border-green-500 focus:ring-2 focus:ring-green-200 dark:bg-gray-700 dark:text-gray-100"
                                       onchange="updateStatus(@i)" />
                            </div>
                        </div>
                    </div>
                }
            </div>

            <!-- Submit Buttons -->
            <div class="flex gap-4 mt-8 pt-6 border-t border-gray-200 dark:border-gray-700">
                <a href="/Partner/ManageSede/@Model.SaloneId" class="inline-flex items-center px-6 py-3 bg-gray-200 dark:bg-gray-700 text-gray-900 dark:text-gray-100 font-medium rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
                    <i class="fas fa-times mr-2"></i>
                    Annulla
                </a>
                <button type="submit" class="inline-flex items-center px-6 py-3 bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg transition-colors ml-auto">
                    <i class="fas fa-save mr-2"></i>
                    Salva Orari
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    // Aggiorna il conteggio dei giorni lavorativi
    function updateWorkDaysDisplay() {
        const checkedBoxes = document.querySelectorAll('input[name="WorkDays"]:checked');
        const count = checkedBoxes.length;
        document.getElementById('work-days-display').textContent = count + (count === 1 ? ' giorno di apertura' : ' giorni di apertura');
    }

    // Toggle visibilità dei campi orari
    function toggleWorkDay(day) {
        const timeInputs = document.getElementById(`time-inputs-${day}`);
        const checkbox = document.querySelector(`input[data-day="${day}"]`);
        
        if (checkbox.checked) {
            timeInputs.classList.remove('hidden');
        } else {
            timeInputs.classList.add('hidden');
        }
        
        updateStatus(day);
        updateWorkDaysDisplay();
    }

    // Aggiorna lo status del giorno
    function updateStatus(day) {
        const checkbox = document.querySelector(`input[data-day="${day}"]`);
        const statusElement = document.getElementById(`status-${day}`);
        const giorno = ['Lunedì', 'Martedì', 'Mercoledì', 'Giovedì', 'Venerdì', 'Sabato', 'Domenica'][day];
        
        if (checkbox.checked) {
            const aperturaInput = document.querySelector(`input[name="Orari[apertura_${day}]"]`);
            const chiusuraInput = document.querySelector(`input[name="Orari[chiusura_${day}]"]`);
            
            if (aperturaInput && chiusuraInput) {
                const apertura = aperturaInput.value;
                const chiusura = chiusuraInput.value;
                statusElement.innerHTML = `<span>${apertura} - ${chiusura}</span>`;
            }
        } else {
            statusElement.innerHTML = '<span>Chiuso</span>';
        }
    }

    // Reset della form
    function resetSchedule() {
        if (confirm('Sei sicuro di voler resettare gli orari?')) {
            document.getElementById('scheduleForm').reset();
            document.querySelectorAll('.time-inputs').forEach(el => el.classList.add('hidden'));
            updateWorkDaysDisplay();
        }
    }

    // Inizializza al caricamento
    document.addEventListener('DOMContentLoaded', function() {
        updateWorkDaysDisplay();
    });
</script>
